<!-- script client : tri + recherche -->
<script type="module">
  // lecture s√ªre des donn√©es pr√©par√©es c√¥t√© serveur
  const initialDataEl = document.getElementById("initial-data");
  const initialData = initialDataEl
    ? JSON.parse(initialDataEl.textContent || "[]")
    : [];

  const weeklyDataEl = document.getElementById("weekly-data");
  const weeklyData = weeklyDataEl
    ? JSON.parse(weeklyDataEl.textContent || "[]")
    : [];

  const sortSelect = document.getElementById("sortSelect");
  const tbody = document.getElementById("rankingBody");
  const tabGlobal = document.getElementById("tab-global");
  const tabWeekly = document.getElementById("tab-weekly");

  let currentTab = "global"; // 'global' ou 'weekly'
  let currentData = initialData;

  // petite util pour √©chapper le HTML (s√©curit√©)
  function escapeHtml(str = "") {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // g√©n√®re le HTML d'une ligne ; on utilise les valeurs pr√©par√©es c√¥t√© serveur
  function rowHtml(user, displayIndex, showGems = true) {
    const medal =
      displayIndex === 0
        ? "ü•á"
        : displayIndex === 1
          ? "ü•à"
          : displayIndex === 2
            ? "ü•â"
            : "";
    const username = escapeHtml(user.username || "Utilisateur anonyme");
    const country = escapeHtml(user.country || "-");
    const region = escapeHtml(user.region || "-");
    const subregion = escapeHtml(user.subregion || "-");
    const formattedDuration = escapeHtml(user.formatted_total_duration || "0s");
    const gemBalance = escapeHtml(String(user.gem_balance || 0));

    const gemColumn = showGems
      ? `<td class="text-right text-accent">${gemBalance}</td>`
      : "";

    return `
      <tr class="hover:bg-secondary/20">
        <th class="text-right flex items-center gap-2">${medal} ${displayIndex + 1}</th>
        <td>
          <a href="/${encodeURIComponent(user.username || "")}" class="text-primary font-bold hover:underline">${username}</a>
        </td>
        <td class="text-right text-accent">${formattedDuration}</td>
        ${gemColumn}
        <td>${country}</td>
        <td>${region}</td>
        <td>${subregion}</td>
      </tr>
    `;
  }

  // render
  function renderTable(users, showGems = true) {
    if (!tbody) return;
    if (!users || users.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center">Aucun utilisateur trouv√©.</td></tr>`;
      return;
    }
    tbody.innerHTML = users.map((u, i) => rowHtml(u, i, showGems)).join("");
  }

  // tri initial (par total_duration_num d√©croissant)
  function sortUsers(users, key) {
    return [...users].sort((a, b) => (b[key] || 0) - (a[key] || 0));
  }

  // fonction pour changer de tab
  function switchTab(tab) {
    currentTab = tab;
    const sortContainer = document.getElementById("sortContainer");
    const gemHeader = document.getElementById("gemHeader");

    if (tab === "global") {
      currentData = initialData;
      tabGlobal.classList.add("btn-active");
      tabGlobal.classList.remove("btn-outline");
      tabWeekly.classList.remove("btn-active");
      tabWeekly.classList.add("btn-outline");

      // Afficher le tri et la colonne gemmes
      if (sortContainer) sortContainer.style.display = "";
      if (gemHeader) gemHeader.style.display = "";

      const currentSortKey = sortSelect
        ? sortSelect.value
        : "total_duration_num";
      renderTable(sortUsers(currentData, currentSortKey), true);
    } else {
      currentData = weeklyData;
      tabWeekly.classList.add("btn-active");
      tabWeekly.classList.remove("btn-outline");
      tabGlobal.classList.remove("btn-active");
      tabGlobal.classList.add("btn-outline");

      // Masquer le tri et la colonne gemmes
      if (sortContainer) sortContainer.style.display = "none";
      if (gemHeader) gemHeader.style.display = "none";

      // Toujours trier par dur√©e pour la ligue
      renderTable(sortUsers(currentData, "total_duration_num"), false);
    }
  }

  // initial render
  let currentSortKey = sortSelect ? sortSelect.value : "total_duration_num";
  renderTable(sortUsers(currentData, currentSortKey), true);

  // handler de changement de tri
  if (sortSelect) {
    sortSelect.addEventListener("change", () => {
      currentSortKey = sortSelect.value;
      // Le tri ne s'applique que pour le classement global
      if (currentTab === "global") {
        renderTable(sortUsers(currentData, currentSortKey), true);
      }
    });
  }

  // handlers pour les tabs
  if (tabGlobal) {
    tabGlobal.addEventListener("click", (e) => {
      e.preventDefault();
      switchTab("global");
    });
  }

  if (tabWeekly) {
    tabWeekly.addEventListener("click", (e) => {
      e.preventDefault();
      switchTab("weekly");
    });
  }
</script>
<script>
  import { getUser } from "src/api/users";

  const input = document.getElementById("usernameInput") as HTMLInputElement;
  const button = document.getElementById("searchBtn") as HTMLButtonElement;
  const errorMsg = document.getElementById("errorMsg") as HTMLParagraphElement;

  button.addEventListener("click", async () => {
    const username = input.value.trim();
    errorMsg.classList.add("hidden");
    errorMsg.textContent = "";

    if (!username) {
      errorMsg.textContent = "Veuillez entrer un pseudo.";
      errorMsg.classList.remove("hidden");
      return;
    }

    const user = await getUser(username);
    if (user) {
      window.location.href = `/${user.username}`;
    } else {
      errorMsg.textContent = "Aucun utilisateur trouv√©.";
      errorMsg.classList.remove("hidden");
    }
  });
</script>
